@model WAMVC.Models.PedidoModel

@{
    ViewData["Title"] = "Detalles del Pedido";
}

<h1>Detalles del Pedido #@Model.Id</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>📋 Información del Pedido</h4>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">
                        @Html.DisplayNameFor(model => model.Cliente!.Nombre)
                    </dt>
                    <dd class="col-sm-8">
                        <a asp-controller="Cliente" asp-action="Details" asp-route-id="@Model.Cliente?.Id" class="text-decoration-none">
                            @Html.DisplayFor(model => model.Cliente!.Nombre)
                        </a>
                    </dd>
                    <dt class="col-sm-4">
                        @Html.DisplayNameFor(model => model.FechaPedido)
                    </dt>
                    <dd class="col-sm-8">
                        @Html.DisplayFor(model => model.FechaPedido)
                    </dd>
                    <dt class="col-sm-4">
                        @Html.DisplayNameFor(model => model.Direccion)
                    </dt>
                    <dd class="col-sm-8">
                        @Html.DisplayFor(model => model.Direccion)
                    </dd>
                    <dt class="col-sm-4">
                        @Html.DisplayNameFor(model => model.MontoTotal)
                    </dt>
                    <dd class="col-sm-8">
                        <strong class="text-success">@Html.DisplayFor(model => model.MontoTotal)</strong>
                    </dd>
                </dl>
            </div>
        </div>

        @if (Model.DetallePedidos != null && Model.DetallePedidos.Any())
        {
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>🛒 Artículos del Pedido</h5>
                    <a asp-controller="DetallePedido" asp-action="Create" asp-route-pedidoId="@Model.Id" class="btn btn-sm btn-success">
                        ➕ Agregar Artículo
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detalle in Model.DetallePedidos)
                                {
                                    <tr>
                                        <td>
                                            <strong>@detalle.Producto?.Nombre</strong>
                                            @if (!string.IsNullOrEmpty(detalle.Producto?.Descripcion))
                                            {
                                                <br><small class="text-muted">@detalle.Producto.Descripcion</small>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-info">@detalle.Cantidad</span>
                                        </td>
                                        <td>@detalle.PrecioUnitario.ToString("C")</td>
                                        <td>
                                            <strong class="text-success">@((detalle.Cantidad * detalle.PrecioUnitario).ToString("C"))</strong>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <a asp-controller="DetallePedido" asp-action="Edit" asp-route-id="@detalle.Id" class="btn btn-sm btn-warning" title="Editar">✏️</a>
                                                <a asp-controller="DetallePedido" asp-action="Details" asp-route-id="@detalle.Id" class="btn btn-sm btn-info" title="Ver Detalles">👁️</a>
                                                <a asp-controller="DetallePedido" asp-action="Delete" asp-route-id="@detalle.Id" class="btn btn-sm btn-danger" title="Eliminar">🗑️</a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="3">Total del Pedido:</th>
                                    <th class="text-success">@Model.DetallePedidos.Sum(d => d.Cantidad * d.PrecioUnitario).ToString("C")</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h5>🛒 Artículos del Pedido</h5>
                </div>
                <div class="card-body text-center">
                    <p class="text-muted">Este pedido aún no tiene artículos agregados.</p>
                    <a asp-controller="DetallePedido" asp-action="Create" asp-route-pedidoId="@Model.Id" class="btn btn-primary">
                        ➕ Agregar Primer Artículo
                    </a>
                </div>
            </div>
        }
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>⚙️ Acciones del Pedido</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-warning">
                        ✏️ Editar Pedido
                    </a>
                    <a asp-controller="DetallePedido" asp-action="Create" asp-route-pedidoId="@Model.Id" class="btn btn-success">
                        ➕ Agregar Artículo
                    </a>
                    <hr>
                    <a asp-action="Index" class="btn btn-secondary">
                        📋 Volver a Lista de Pedidos
                    </a>
                    <a asp-controller="DetallePedido" asp-action="Index" class="btn btn-outline-info">
                        📄 Gestionar Detalles
                    </a>
                </div>
            </div>
        </div>

        @if (Model.DetallePedidos != null && Model.DetallePedidos.Any())
        {
            <div class="card mt-3">
                <div class="card-header">
                    <h6>📊 Resumen del Pedido</h6>
                </div>
                <div class="card-body">
                    <p><strong>Artículos únicos:</strong> @Model.DetallePedidos.Count()</p>
                    <p><strong>Cantidad total:</strong> @Model.DetallePedidos.Sum(d => d.Cantidad) unidades</p>
                    <p><strong>Monto registrado:</strong> <span class="text-success">@Model.MontoTotal.ToString("C")</span></p>
                    <p><strong>Monto calculado:</strong> <span class="text-info">@Model.DetallePedidos.Sum(d => d.Cantidad * d.PrecioUnitario).ToString("C")</span></p>
                    
                    @{
                        var diferencia = Model.MontoTotal - Model.DetallePedidos.Sum(d => d.Cantidad * d.PrecioUnitario);
                    }
                    
                    @if (Math.Abs(diferencia) > 0.01m)
                    {
                        <p><strong>Diferencia:</strong> <span class="text-warning">@diferencia.ToString("C")</span></p>
                        <small class="text-muted">Puede necesitar recalculación</small>
                    }
                    else
                    {
                        <p><span class="text-success">✅ Montos coinciden</span></p>
                    }
                </div>
            </div>
        }
    </div>
</div>

<div class="mt-3">
    <a asp-action="Edit" asp-route-id="@Model?.Id" class="btn btn-warning">Editar</a>
    <a asp-action="Index" class="btn btn-secondary">Volver a la Lista</a>
</div>